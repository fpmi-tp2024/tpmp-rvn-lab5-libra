# Автопарк

- [Описание классов](#описание-классов)
  - [Auth](#auth)
  - [Car](#car)
  - [CarStorer](#carstorer)
  - [Order](#order)
  - [OrderStorer](#orderstorer)
  - [Driver](#driver)
  - [DriverStorer](#driverstorer)
  - [Config](#config)
  - [Validator](#validator)
- [Использование](#использование)
  - [Сборка](#сборка)
- [Тестирование](#тестирование)
  - [Validator tests](#validator-tests)
  - [Make dataset](#make-dataset)
  - [Auth tests](#auth-tests)
  - [CarStorer tests](#carstorer-tests)
  - [OrderStorer tests](#orderstorer-tests)
  - [DriverStorer tests](#driverstorer-tests)


## Описание классов

### Auth

Класс `Auth` предоставляет методы для аутентификации пользователей. Он использует базу данных SQLite для хранения информации о пользователях. Класс `Auth` использует библиотеку `openssl` для хеширования паролей пользователей.

Класс `Auth` содержит следующие методы:

- `Auth(const std::string &db_name)`: конструктор, создающий объект `Auth` и открывающий базу данных с именем `db_name`. Если база данных не существует, она будет создана.
- `~Auth()`: деструктор, закрывающий базу данных.
- `bool userExists(const std::string &login)`: метод, проверяющий, существует ли пользователь с логином `login` в базе данных.
- `UserType checkPassword(const std::string &login, const std::string &password)`: метод, проверяющий, совпадает ли пароль `password` с паролем пользователя с логином `login` в базе данных. Если логин или пароль неверны, метод выбрасывает исключение `std::runtime_error`. Если логин и пароль верны, метод возвращает тип пользователя (`UserType::ADMIN` или `UserType::DRIVER`).
- `void changePassword(const std::string &login, const std::string &oldPassword, const std::string &newPassword)`: метод, изменяющий пароль пользователя с логином `login` в базе данных. Метод проверяет, что старый пароль `oldPassword` совпадает с паролем пользователя в базе данных, а новый пароль `newPassword` не является пустым. Если проверка пройдена успешно, метод изменяет пароль пользователя в базе данных.
- `void changeLogin(const std::string &oldLogin, const std::string &newLogin, const std::string &password)`: метод, изменяющий логин пользователя в базе данных. Метод проверяет, что старый логин `oldLogin` существует в базе данных, а новый логин `newLogin` не существует и не является пустым. Если проверка пройдена успешно, метод изменяет логин пользователя в базе данных.
- `void addUser(const std::string &login, const std::string &password, UserType user_type)`: метод, добавляющий нового пользователя в базу данных. Метод проверяет, что логин `login` не существует в базе данных, пароль `password` не является пустым, и тип пользователя `user_type` является допустимым значением перечисления `UserType`. Если проверка пройдена успешно, метод добавляет нового пользователя в базу данных.
- `void deleteUser(const std::string &login)`: метод, удаляющий пользователя с логином `login` из базы данных. Если пользователь с таким логином не существует, метод выбрасывает исключение `std::runtime_error`.

Класс `Auth` использует хеширование паролей с помощью библиотеки `openssl`. В частности, метод `checkPassword` хеширует пароль `password` с помощью функции `SHA256` и сравнивает полученный хеш с хешем пароля пользователя в базе данных. Методы `changePassword` и `addUser` также хешируют пароли перед сохранением их в базе данных.

### Car

> Класс `Car` также использует класс `Validator` для проверки корректности вводимых данных.

Класс `Car` содержит следующие параметры:

- `number` - государственный номер автомобиля РБ (уникальный)
- `brand` - марка автомобиля
- `model` - модель автомобиля
- `purchaseMileage` - пробег на момент покупки
- `carryingCapacity` - грузоподъемность

Класс предоставляет следующие методы:

- ` Car()`: конструктор по умолчанию, создающий объект Car с пустыми полями.
- `Car(const std::string &number, const std::string &brand, const std::string &model, int carryingCapacity, int mileage)`: конструктор, создающий объект Car с заданными параметрами.
- `Car(sqlite3_stmt *statement)`: конструктор, создающий объект Car на основе данных из SQL-запроса.
- `getNumber()`: возвращает государственный номер автомобиля.
- `getBrand()`: возвращает марку автомобиля.
- `getModel()`: возвращает модель автомобиля.
- `getPurchaseMileage()`: возвращает пробег автомобиля на момент покупки.
- `getCarryingCapacity()`: возвращает грузоподъемность автомобиля.
- `setNumber(const std::string &number)`: устанавливает государственный номер автомобиля.
- `setBrand(const std::string &brand)`: устанавливает марку автомобиля.
- `setModel(const std::string &model)`: устанавливает модель автомобиля.
- `setMileage(int purchaseMileage)`: устанавливает пробег автомобиля на момент покупки.
- `setCarryingCapacity(int carryingCapacity)`: устанавливает грузоподъемность автомобиля.
- `toString()`: возвращает строковое представление объекта Car.

### CarStorer

Класс `CarStorer` предоставляет методы для работы с таблицей `Cars` в базе данных SQLite. Он содержит следующие методы:

- `CarStorer(const std::string &dbName)`: конструктор, создающий объект `CarStorer` и открывающий базу данных с именем `dbName`. Если база данных не существует, она будет создана.
- `std::pair<int, int> getCarTotalMileageAndMass(std::string carNumber)`: метод, возвращающий пару `std::pair<int, int>`, содержащую общий пробег и общую массу груза для автомобиля с номером `carNumber`.
- `int callbackForTotalMileageAndMass(void *data, int colCount, char **columns, char **colNames)`: статический метод, используемый в качестве callback-функции для `sqlite3_exec`. Он преобразует данные из результирующего набора в пару `std::pair<int, int>`.
- `Car getCarWithMaximumMileage()`: метод, возвращающий объект `Car`, соответствующий автомобилю с максимальным пробегом.
- `std::vector<Car> getAllCars()`: метод, возвращающий вектор `std::vector<Car>`, содержащий все автомобили из таблицы `Cars`.
- `void updateCar(std::string carNumber, const Car &car)`: метод, обновляющий данные автомобиля с номером `carNumber` в таблице `Cars`.
- `void addCar(const Car &car)`: метод, добавляющий новый автомобиль в таблицу `Cars`.
- `void removeCar(std::string carNumber)`: метод, удаляющий автомобиль с номером `carNumber` из таблицы `Cars`.
- `~CarStorer()`: деструктор, закрывающий базу данных.
- `Car getCarByNumber(std::string carNumber)`: метод, возвращающий объект `Car`, соответствующий автомобилю с номером `carNumber`.
 
### Order

> Класс `Order` также использует класс `Validator` для проверки корректности вводимых данных.

Класс `Order` представляет заказ и содержит следующие поля:

- `id`: уникальный идентификатор заказа, представленный в виде целого числа.
- `date`: дата заказа, представленная в виде целого числа (UNIX-время).
- `driverId`: идентификатор водителя, выполнившего заказ, представленный в виде целого числа.
- `carNumber`: государственный номер автомобиля, выполнившего заказ, представленный в виде строки.
- `mileage`: пробег автомобиля на момент выполнения заказа, представленный в виде целого числа.
- `cargoWeight`: масса груза, представленная в виде целого числа.
- `cost`: стоимость заказа, представленная в виде целого числа.

Класс предоставляет следующие методы:

- `Order(int id, long date, int driverId, const std::string &carNumber, int mileage, int cargoWeight, int cost)`: конструктор, создающий объект `Order` с заданными параметрами.
> id должен быть установлен -1 для создания нового заказа, не помещенного в базу данных.
- `Order(sqlite3_stmt *statement)`: конструктор, создающий объект `Order` на основе данных из SQL-запроса.
- `getId()`: возвращает идентификатор заказа.
- `getDate()`: возвращает дату заказа.
- `getDriverId()`: возвращает идентификатор водителя, выполнившего заказ.
- `getCarNumber()`: возвращает государственный номер автомобиля, выполнившего заказ.
- `getMileage()`: возвращает пробег автомобиля на момент выполнения заказа.
- `getCargoWeight()`: возвращает массу груза.
- `getCost()`: возвращает стоимость заказа.
- `setID(int id)`: устанавливает идентификатор заказа.
- `setDate(long date)`: устанавливает дату заказа.
- `setDriverId(int driverId)`: устанавливает идентификатор водителя, выполнившего заказ.
- `setCarNumber(const std::string &carNumber)`: устанавливает государственный номер автомобиля, выполнившего заказ.
- `setMileage(int mileage)`: устанавливает пробег автомобиля на момент выполнения заказа.
- `setCargoWeight(int cargoWeight)`: устанавливает массу груза.
- `setCost(int cost)`: устанавливает стоимость заказа.
- `toString()`: возвращает строковое представление объекта `Order`.

### OrderStorer

Класс `OrderStorer` представляет хранилище заказов и предоставляет методы для работы с ними. Он использует SQLite для хранения данных.

Класс содержит следующие методы:

- `OrderStorer(const std::string &dbName)`: конструктор, создающий объект `OrderStorer` и подключающийся к базе данных с именем `dbName`. Если база данных не существует, она будет создана.
- `addOrder(Order &order)`: добавляет новый заказ в базу данных.
- `~OrderStorer()`: деструктор, закрывающий подключение к базе данных.
- `getTotalNumberOfOrders(const int driverID)`: возвращает общее количество заказов для водителя с идентификатором `driverID`.
- `getTotalCargoMass(const int driverID)`: возвращает общую массу груза для водителя с идентификатором `driverID`.
- `getTotalMoney(const int driverID, long start, long end)`: возвращает общую стоимость заказов для водителя с идентификатором `driverID` в указанном диапазоне дат.
- `removeOrder(int orderId)`: удаляет заказ с идентификатором `orderId` из базы данных.
- `getOrderById(int orderId)`: возвращает заказ с идентификатором `orderId` из базы данных.
- `getAllOrders()`: возвращает все заказы из базы данных.

### Driver

Класс `Driver` представляет водителя и содержит следующие поля:

- `id`: уникальный идентификатор водителя, представленный в виде целого числа.
- `login`: логин водителя, представленный в виде строки.
- `name`: имя водителя, представленное в виде строки.
- `category`: категория водительских прав, представленная в виде строки.
- `startWorkDate`: дата начала работы водителя, представленная в виде целого числа (UNIX-время).
- `birthYear`: год рождения водителя, представленный в виде целого числа.
- `address`: адрес водителя, представленный в виде строки.

Класс предоставляет следующие методы:

- `Driver(int id, const std::string &login, const std::string &name, const std::string &category, const long &startWorkDate, int birthYear, const std::string &address)`: конструктор, создающий объект `Driver` с заданными параметрами.
> id должен быть установлен -1 для создания нового водителя, не помещенного в базу данных.
- `Driver(sqlite3_stmt *statement)`: конструктор, создающий объект `Driver` на основе данных из SQL-запроса.
- `getId()`: возвращает идентификатор водителя.
- `getName()`: возвращает имя водителя.
- `getLogin()`: возвращает логин водителя.
- `getCategory()`: возвращает категорию водительских прав.
- `getStartWorkDate()`: возвращает дату начала работы водителя.
- `getAddress()`: возвращает адрес водителя.
- `getBirthYear()`: возвращает год рождения водителя.
- `setId(int id)`: устанавливает идентификатор водителя.
- `setName(const std::string &name)`: устанавливает имя водителя.
- `setLogin(const std::string &login)`: устанавливает логин водителя.
- `setCategory(const std::string &category)`: устанавливает категорию водительских прав.
- `setAddress(const std::string &address)`: устанавливает адрес водителя.
- `toString()`: возвращает строковое представление объекта `Driver`.

### DriverStorer

Класс `DriverStorer` предоставляет методы для работы с водителями и их заказами в базе данных SQLite. Класс содержит следующие методы:

- `DriverStorer(const std::string &dbName)`: конструктор, создающий объект `DriverStorer` и открывающий базу данных с именем `dbName`.
- `getDriverById(const int driverId)`: возвращает объект `Driver` с указанным идентификатором.
- `getDriverByLogin(const std::string &login)`: возвращает объект `Driver` с указанным логином.
- `getOrdersByDriverAndPeriod(int driverId, long startDate = -1, long endDate = -1)`: возвращает вектор объектов `Order`, выполненных водителем с указанным идентификатором в указанный период. Если `startDate` и `endDate` не указаны, то возвращаются все заказы водителя.
- `getDriverWithMinimumTripsAndMoney()`: возвращает пару объектов `Driver` и `double`, где `Driver` - водитель, выполнивший наименьшее количество заказов, а `double` - сумма денег, полученных этим водителем.
- `getDrivers()`: возвращает вектор объектов `Driver`, содержащий всех водителей в базе данных.
- `updateAddress(int driverId, const std::string &address)`: обновляет адрес водителя с указанным идентификатором.
- `addDriver(Driver &driver)`: добавляет нового водителя в базу данных.
- `removeDriver(int driverId)`: удаляет водителя с указанным идентификатором из базы данных.
- `~DriverStorer()`: деструктор, закрывающий базу данных.

### Config

Класс `Config` представляет конфигурационный файл приложения и предоставляет методы для чтения значений из этого файла.

> класс реализован с использованием паттерна Singleton.

Конфигурационный файл должен быть текстовым файлом с именем `config.txt`, расположенным в папке `config`. Формат файла следующий:
```makefile
key1='string_value1'
key2=int_value2
...
```
Значения могут быть как строками, так и целыми числами. Строковые значения **должны быть заключены в одиночные кавычки**.

Класс `Config` предоставляет следующие методы:

- `Config()`: конструктор, создающий объект `Config` и считывающий данные из конфигурационного файла.
- `getInstance()`: статический метод, возвращающий ссылку на единственный экземпляр класса `Config`.
- `getString(const std::string &key)`: статический метод, возвращающий строковое значение для заданного ключа из конфигурационного файла.
- `getInt(const std::string &key)`: статический метод, возвращающий целочисленное значение для заданного ключа из конфигурационного файла.

Если ключ не найден в конфигурационном файле или значение для ключа некорректно, то генерируется исключение `std::runtime_error`.

Пример использования:
```cpp
std::string value = Config::getString("key1");
int value =  Config::getInt("key2");
```

### Validator

Класс `Validator` предоставляет статические методы для проверки корректности ввода данных. Он использует регулярные выражения для проверки строковых значений и диапазоны значений для проверки целочисленных значений.

#### Статические поля

- `NUMBER_PLATE_REGEX` - регулярное выражение для проверки номера автомобиля
- `BRAND_REGEX` - регулярное выражение для проверки марки автомобиля
- `NAME_REGEX` - регулярное выражение для проверки имени водителя
- `LOGIN_REGEX` - регулярное выражение для проверки логина водителя
- `CATEGORY_REGEX` - регулярное выражение для проверки категории водительских прав
- `ADDRESS_REGEX` - регулярное выражение для проверки адреса водителя

#### Статические методы

- `isValidNumberPlate(const std::string &numberPlate)` - проверяет, соответствует ли номер автомобиля регулярному выражению `NUMBER_PLATE_REGEX`
- `isValidBrand(const std::string &brand)` - проверяет, соответствует ли марка автомобиля регулярному выражению `BRAND_REGEX`
- `isValidName(const std::string &name)` - проверяет, соответствует ли имя водителя регулярному выражению `NAME_REGEX`
- `isValidLogin(const std::string &login)` - проверяет, соответствует ли логин водителя регулярному выражению `LOGIN_REGEX`
- `isValidCategory(const std::string &category)` - проверяет, соответствует ли категория водительских прав регулярному выражению `CATEGORY_REGEX`
- `isValidAddress(const std::string &address)` - проверяет, соответствует ли адрес водителя регулярному выражению `ADDRESS_REGEX`
- `isValidMileage(int mileage)` - проверяет, входит ли пробег автомобиля в диапазон допустимых значений
- `isValidCarryingCapacity(int carryingCapacity)` - проверяет, входит ли грузоподъемность автомобиля в диапазон допустимых значений
- `isValidCargoMass(int cargoMass)` - проверяет, входит ли масса груза в диапазон допустимых значений
- `isValidCost(int cost)` - проверяет, входит ли стоимость заказа в диапазон допустимых значений

#### Примеры использования

```cpp
std::string numberPlate = "AB123CD";
if (Validator::isValidNumberPlate(numberPlate)) {
    std::cout << "Number plate is valid" << std::endl;
} else {
    std::cout << "Number plate is invalid" << std::endl;
}

int mileage = 100000;
if (Validator::isValidMileage(mileage)) {
    std::cout << "Mileage is valid" << std::endl;
} else {
    std::cout << "Mileage is invalid" << std::endl;
}
```

#### Зависимости

- `config.hpp`

Класс использует конфигурационный файл для получения значений регулярных выражений и диапазонов значений.

## Использование

### Сборка

1. Установка зависимостей

   Прежде чем начинать, убедитесь, что у вас установлен `g++`, `libsqlite3-dev` и `libssl-dev`. Вы можете установить их на с помощью следующей команды:
   
   Linux:
   ```bash
   sudo apt-get install g++ libsqlite3-dev libssl-dev
   ```
   MacOS:
   ```bash
   brew install sqlite3 openssl
   ```
2. Клонирование репозитория

   Клонируйте репозиторий с исходным кодом приложения с помощью следующей команды:
   ```bash
   git clone https://github.com/fpmi-tp2024/tpmp-rvn-lab5-libra
   ```
3. Сборка приложения

   Перейдите в каталог с исходным кодом приложения и выполните следующую команду для сборки приложения:
   ```bash
   make build
   ```
   Эта команда скомпилирует исходный код и создаст исполняемый файл `program` в каталоге `bin/`.
4. Запуск тестов

   Вы можете запустить тесты для приложения, выполнив следующую команду:
   ```bash
   make test
   ```
   Эта команда удалит файл базы данных `test.db` в каталоге `data/` (если он существует), затем скомпилирует и запустит тесты.
5. Запуск приложения

   Вы можете запустить приложение, выполнив следующую команду:
   ```bash
   make run
   ```
   Эта команда запустит приложение.
6. Очистка

   Вы можете очистить все файлы, созданные во время сборки и запуска приложения, выполнив следующую команду:
   ```bash
   make clean
   ```
   Эта команда удалит все объектные файлы и исполняемые файлы из каталогов `obj/` и `bin/`.

## Тестирование

Все тесты написаны с использованием библиотеки Catch2. Для запуска тестов достаточно выполнить команду `make test`.
Тесты для приложения разделены на основные группы:

1. **Validator tests** - проверяют корректность работы класса `Validator`, который используется для валидации входных данных.
2. **Make dataset** - создают набор тестовых данных для базы данных приложения, включая водителей, автомобили и заказы.
3. **Auth tests** - проверяют корректность работы класса `Auth`, который предоставляет методы для аутентификации пользователей.
4. **CarStorer tests** - проверяют корректность работы класса `CarStorer`, который предоставляет методы для работы с автомобилями в базе данных.
5. **OrderStorer tests** - проверяют корректность работы класса `OrderStorer`, который предоставляет методы для работы с заказами в базе данных.
6. **DriverStorer tests** - проверяют корректность работы класса `DriverStorer`, который предоставляет методы для работы с водителями в базе данных.

### Validator tests

В этой группе тестов проверяется корректность работы методов класса `Validator`. Тесты включают проверку валидации номера автомобиля, марки, имени водителя, логина, категории, адреса, пробега, грузоподъемности, массы груза и стоимости.

### Make dataset

В этой группе тестов создается набор тестовых данных для базы данных приложения. В частности, создаются пользователи, водители, автомобили и заказы. Для каждого водителя создается уникальный логин и пароль, а также указываются имя, категория, дата рождения и адрес. Для каждого автомобиля указываются номер, марка, модель, пробег и грузоподъемность. Для каждого заказа указываются дата, номер автомобиля, водитель, пробег, масса груза и стоимость.

### Auth tests

В этой группе тестов проверяется корректность работы методов класса `Auth`. Тесты включают проверку аутентификации пользователя по логину и паролю, проверки существования пользователя по логину, проверки существования пользователя по логину и паролю, добавления пользователя, удаления пользователя.

### CarStorer tests

В этой группе тестов проверяется корректность работы методов класса `CarStorer`. Тесты включают проверку получения общего пробега и массы груза для каждого автомобиля, получения автомобиля с максимальным пробегом, получения всех автомобилей, обновления данных автомобиля и удаления автомобиля.

### OrderStorer tests

В этой группе тестов проверяется корректность работы методов класса `OrderStorer`. Тесты включают проверку получения общего количества заказов для каждого водителя, общей массы груза для каждого водителя, общей стоимости заказов для каждого водителя, получения заказа по идентификатору, получения всех заказов, удаления заказа.

### DriverStorer tests

В этой группе тестов проверяется корректность работы методов класса `DriverStorer`. Тесты включают проверку получения водителя по идентификатору, получения водителя по логину, получения водителя по логину и паролю, получения водителя с минимальным количеством заказов и минимальной стоимостью, обновления адреса водителя, обновления логина водителя, обновления пароля водителя, получения заказов водителя за определенный период, получения всех водителей, удаления водителя.